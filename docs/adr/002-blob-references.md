# Описание работы с блобами

## Проблема
Массивы байт приходят в систему в XML виде base64. Кодировть/декодировать такие данные очень ресурсоемкая операция 
(см modules/jmh-tests). Гораздо удобней перед декодированием в jaxb-объекты блобы заменять на некие ссылки, а сами 
блобы хранить в отдельном хранилище.

Преобразование массива байт в base64 не однозначная операция из-за переносов строк. (причем и сами переносы могут 
кодироваться как 0x0a, так и 0x0d0a). 
Поэтому для корректного восстановления исходных сообщений нужно сохранять информацию о переносе строк.

## Принято решение
Строки, представляющие собой блобы, архивируются как есть (в base64). Далее - по архиву считается хэш (murmurhash3_128).
Хэш кодируется в base64. Полученное значение будем считать ссылкой на блобы. (ref = base64(murmurhash3_128(bytes_from_xml_in_base64)))
Блоб сохраняется в хранилище по пути /$lifecycleID/$ref. 

Вместо исходного массива в XML для дальнейшего использования вставляется ссылка на блоб с фиксированным префиксом "QkxPQlo6.  
Вместо исходного блоба в xml/json вписывается строка "QkxPQlo6" + $ref.

java-сериализаторы/десериализаторы воспринимают такую строку как обычный base64. По префиксу "QkxPQlo6" в дальнейшем 
можно понять, что это ссылка на блоб и восстановить данные потоковым обработчиком.

Для работы нужно:
- сначала блобы найти - то есть нужно знать где они находятся в XML. В проде эта метаинформация 
берется из XSD, в проекте пути до блобов просто вбиты в код.
- потом заменить в потоке данных ссылки на блобы - для этого используем префмикс "QkxPQlo6"

## Результаты:
jmh показывает что jaxb работает на 1-2 порядка быстрее со ссылками чем с исходными блобами.

![jaxb-jmh-results](../img/02-jmh-jaxb-results.png)
